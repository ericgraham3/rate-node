 1. Test Files Overview                                                                                                                                                                                                                                                                              
  ┌───────────────────────┬──────────────────────────┬────────────────────────────┐                                                                                                                                                                                                                   
  │         File          │           Type           │          Location          │                                                                                                                                                                                                                   
  ├───────────────────────┼──────────────────────────┼────────────────────────────┤                                                                                                                                                                                                                   
  │ spec_helper.rb        │ Configuration            │ spec/                      │                                                                                                                                                                                                                   
  ├───────────────────────┼──────────────────────────┼────────────────────────────┤                                                                                                                                                                                                                   
  │ calculator_spec.rb    │ Unit Test (RSpec)        │ spec/ratenode/             │                                                                                                                                                                                                                   
  ├───────────────────────┼──────────────────────────┼────────────────────────────┤                                                                                                                                                                                                                   
  │ base_rate_spec.rb     │ Unit Test (RSpec)        │ spec/ratenode/calculators/ │                                                                                                                                                                                                                   
  ├───────────────────────┼──────────────────────────┼────────────────────────────┤                                                                                                                                                                                                                   
  │ endorsement_spec.rb   │ Unit Test (RSpec)        │ spec/ratenode/models/      │                                                                                                                                                                                                                   
  ├───────────────────────┼──────────────────────────┼────────────────────────────┤                                                                                                                                                                                                                   
  │ csv_scenarios_spec.rb │ Integration Test (RSpec) │ spec/integration/          │                                                                                                                                                                                                                   
  ├───────────────────────┼──────────────────────────┼────────────────────────────┤                                                                                                                                                                                                                   
  │ tx_test.rb            │ Standalone Script        │ spec/                      │                                                                                                                                                                                                                   
  ├───────────────────────┼──────────────────────────┼────────────────────────────┤                                                                                                                                                                                                                   
  │ generate_test_csv.rb  │ Helper Script            │ spec/support/              │                                                                                                                                                                                                                   
  └───────────────────────┴──────────────────────────┴────────────────────────────┘                                                                                                                                                                                                                   
  Supporting Files                                                                                                                                                                                                                                                                                    
  ┌─────────────────────┬─────────────────────────────┐                                                                                                                                                                                                                                               
  │        File         │           Purpose           │                                                                                                                                                                                                                                               
  ├─────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                               
  │ scenarios_input.csv │ Integration test input data │                                                                                                                                                                                                                                               
  ├─────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                               
  │ test_scenarios.csv  │ Generated expected values   │                                                                                                                                                                                                                                               
  ├─────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                               
  │ examples.txt        │ RSpec status persistence    │                                                                                                                                                                                                                                               
  └─────────────────────┴─────────────────────────────┘                                                                                                                                                                                                                                               
  ---                                                                                                                                                                                                                                                                                                 
  2. Test File Descriptions                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                      
  spec_helper.rb                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                      
  Purpose: RSpec configuration and test suite setup                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                      
  - Configures RSpec expectations and mocks                                                                                                                                                                                                                                                           
  - Enables random test ordering                                                                                                                                                                                                                                                                      
  - Sets up in-memory SQLite database before suite runs                                                                                                                                                                                                                                               
  - Persists test status to examples.txt                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                      
  calculator_spec.rb                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                      
  Purpose: Tests the main RateNode::Calculator class (CA rates only)                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                      
  - 11 test cases covering purchase/refinance transactions                                                                                                                                                                                                                                            
  - Tests policy types: standard, extended (125%), homeowner (110%)                                                                                                                                                                                                                                   
  - Tests lender policy scenarios: concurrent, exceeding owner liability                                                                                                                                                                                                                              
  - Validates premium calculations against expected values                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                      
  base_rate_spec.rb                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                      
  Purpose: Tests RateNode::Calculators::BaseRate liability rounding                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                      
  - 4 test cases for CA/TRG rounding behavior                                                                                                                                                                                                                                                         
  - Validates $10K boundary rounding logic                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                      
  endorsement_spec.rb                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                      
  Purpose: Tests RateNode::Models::Endorsement premium calculations                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                      
  - 4 test cases covering pricing types:                                                                                                                                                                                                                                                              
    - Flat fee endorsements                                                                                                                                                                                                                                                                           
    - No-charge endorsements                                                                                                                                                                                                                                                                          
    - Percentage endorsements                                                                                                                                                                                                                                                                         
    - Percentage with minimum                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                      
  csv_scenarios_spec.rb                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                      
  Purpose: Data-driven integration tests from CSV file                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                      
  - Reads scenarios from scenarios_input.csv                                                                                                                                                                                                                                                          
  - Tests CA/TRG and NC/TRG combinations                                                                                                                                                                                                                                                              
  - Validates: owners premium, lenders premium, endorsements, CPL, reissue discount                                                                                                                                                                                                                   
  - Uses $2 tolerance for rounding differences                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                      
  tx_test.rb                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                      
  Purpose: Standalone TX rate validation script (NOT RSpec)                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                      
  - Tests 2019 TX rates against PDF validation examples                                                                                                                                                                                                                                               
  - 4 lookup table tests ($25k-$100k range)                                                                                                                                                                                                                                                           
  - 7 formula-based tests (>$100k, from official PDF examples)                                                                                                                                                                                                                                        
  - Tests CPL ($0) and concurrent lender ($100)                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                      
  generate_test_csv.rb                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                      
  Purpose: Helper script to generate expected test values                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                      
  - Reads scenarios_input.csv                                                                                                                                                                                                                                                                         
  - Calculates premiums using RateNode                                                                                                                                                                                                                                                                
  - Outputs test_scenarios.csv with expected values                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                      
  ---                                                                                                                                                                                                                                                                                                 
  3. Testing Patterns & Frameworks                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                      
  Framework: RSpec 3.x                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                      
  # Gemfile                                                                                                                                                                                                                                                                                           
  gem "rspec", "~> 3.12"                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                      
  Patterns Used                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                      
  Subject/Context Pattern (calculator_spec.rb):                                                                                                                                                                                                                                                       
  context "purchase with extended owner policy (125%)" do                                                                                                                                                                                                                                             
    subject(:result) do                                                                                                                                                                                                                                                                               
      described_class.new(                                                                                                                                                                                                                                                                            
        state: "CA",                                                                                                                                                                                                                                                                                  
        underwriter: "TRG",                                                                                                                                                                                                                                                                           
        # ...                                                                                                                                                                                                                                                                                         
      ).calculate                                                                                                                                                                                                                                                                                     
    end                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                      
    it "calculates extended owner policy premium at 125%" do                                                                                                                                                                                                                                          
      expect(result.owners_policy[:premium_cents]).to eq(196_375)                                                                                                                                                                                                                                     
    end                                                                                                                                                                                                                                                                                               
  end                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                      
  Let/Context Pattern (endorsement_spec.rb):                                                                                                                                                                                                                                                          
  context "flat fee endorsement" do                                                                                                                                                                                                                                                                   
    let(:endorsement) { described_class.find_by_code("CLTA 115", state: "CA", underwriter: "TRG") }                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                      
    it "returns the flat base amount" do                                                                                                                                                                                                                                                              
      expect(endorsement.calculate_premium(50_000_000, state: "CA", underwriter: "TRG")).to eq(2500)                                                                                                                                                                                                  
    end                                                                                                                                                                                                                                                                                               
  end                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                      
  Data-Driven Testing (csv_scenarios_spec.rb):                                                                                                                                                                                                                                                        
  CSV.foreach(csv_path, headers: true) do |row|                                                                                                                                                                                                                                                       
    # Build params from CSV row                                                                                                                                                                                                                                                                       
    result = RateNode.calculate(params)                                                                                                                                                                                                                                                               
    # Compare with tolerance                                                                                                                                                                                                                                                                          
    expect(actual_total - expected_total).to be <= tolerance                                                                                                                                                                                                                                          
  end                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                      
  Standalone Script (tx_test.rb):                                                                                                                                                                                                                                                                     
  # Direct Ruby script with manual assertions                                                                                                                                                                                                                                                         
  status = premium_cents == expected_cents ? "PASS" : "FAIL"                                                                                                                                                                                                                                          
  puts "#{status}: $#{amount} → $#{premium_cents / 100}"                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                      
  ---                                                                                                                                                                                                                                                                                                 
  4. Examples from Each Test Type                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                      
  Unit Test (RSpec)                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                      
  # calculator_spec.rb:24-26                                                                                                                                                                                                                                                                          
  it "calculates standard owner policy premium at 100% of schedule rate" do                                                                                                                                                                                                                           
    expect(result.owners_policy[:premium_cents]).to eq(157_100)                                                                                                                                                                                                                                       
  end                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                      
  Integration Test (RSpec + CSV)                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                      
  # csv_scenarios_spec.rb:121-123                                                                                                                                                                                                                                                                     
  if owners_diff > tolerance || lenders_diff > tolerance                                                                                                                                                                                                                                              
    failures << { scenario: scenario_name, owners: { expected: expected, actual: actual } }                                                                                                                                                                                                           
  end                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                      
  Standalone Script                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                      
  # tx_test.rb:47-51                                                                                                                                                                                                                                                                                  
  premium_cents = calc.calculate                                                                                                                                                                                                                                                                      
  status = premium_cents == expected_cents ? "PASS" : "FAIL"                                                                                                                                                                                                                                          
  puts "#{status}: $#{test[:amount]} → $#{premium_cents / 100} (expected: $#{test[:expected]})"                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                      
  ---                                                                                                                                                                                                                                                                                                 
  5. Inconsistencies & Redundancies                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                      
  Inconsistencies                                                                                                                                                                                                                                                                                     
  ┌────────────────────────┬───────────────────────────────────────────────────────────────────────────┬───────────────────────────────────────────────────┐                                                                                                                                          
  │         Issue          │                                 Location                                  │                      Impact                       │                                                                                                                                          
  ├────────────────────────┼───────────────────────────────────────────────────────────────────────────┼───────────────────────────────────────────────────┤                                                                                                                                          
  │ TX tests not in RSpec  │ tx_test.rb                                                                │ TX tests run separately from bundle exec rspec    │                                                                                                                                          
  ├────────────────────────┼───────────────────────────────────────────────────────────────────────────┼───────────────────────────────────────────────────┤                                                                                                                                          
  │ Duplicate CSV files    │ test_scenarios.csv vs scenarios_input.csv                                 │ test_scenarios.csv appears unused by actual tests │                                                                                                                                          
  ├────────────────────────┼───────────────────────────────────────────────────────────────────────────┼───────────────────────────────────────────────────┤                                                                                                                                          
  │ State coverage gaps    │ Unit tests only cover CA                                                  │ NC and TX lack unit test coverage                 │                                                                                                                                          
  ├────────────────────────┼───────────────────────────────────────────────────────────────────────────┼───────────────────────────────────────────────────┤                                                                                                                                          
  │ Database setup differs │ spec_helper.rb uses :memory:, CSV spec calls setup_database without param │ Potential state leakage                           │                                                                                                                                          
  └────────────────────────┴───────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────┘                                                                                                                                          
  Redundancies                                                                                                                                                                                                                                                                                        
  ┌──────────────────────────┬──────────────────────────────────────────┬───────────────────────────────────────────────────────────────┐                                                                                                                                                             
  │          Issue           │                  Files                   │                          Description                          │                                                                                                                                                             
  ├──────────────────────────┼──────────────────────────────────────────┼───────────────────────────────────────────────────────────────┤                                                                                                                                                             
  │ Overlapping scenarios    │ test_scenarios.csv + scenarios_input.csv │ Two CSV files with similar data, only one used                │                                                                                                                                                             
  ├──────────────────────────┼──────────────────────────────────────────┼───────────────────────────────────────────────────────────────┤                                                                                                                                                             
  │ TX validation duplicated │ Could be in RSpec                        │ tx_test.rb duplicates what could be parameterized RSpec tests │                                                                                                                                                             
  └──────────────────────────┴──────────────────────────────────────────┴───────────────────────────────────────────────────────────────┘                                                                                                                                                             
  Recommendations                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                      
  1. Convert tx_test.rb to RSpec - Add TX test cases to calculator_spec.rb or create tx_calculator_spec.rb                                                                                                                                                                                            
  2. Remove unused CSV - test_scenarios.csv appears to be generated output, not test input                                                                                                                                                                                                            
  3. Add NC/TX unit tests - Current unit tests only cover CA; NC and TX rely solely on integration tests                                                                                                                                                                                              
  4. Standardize database setup - Use consistent :memory: or persistent database across all tests                                                                                                                                                                                                     
  5. Add TX to CSV scenarios - scenarios_input.csv only has CA and NC scenarios                  
# Implementation Plan: Fix NC Simultaneous Issue Base Premium Liability

**Branch**: `005-fix-nc-simul-premium` | **Date**: 2026-02-05 | **Spec**: `specs/005-fix-nc-simul-premium/spec.md`
**Input**: Feature specification from `/specs/005-fix-nc-simul-premium/spec.md`

## Summary

NC simultaneous issue transactions where the Loan Policy coverage exceeds the Owner's Policy coverage produce an under-calculated base premium. PR-4 of the NC rate manual mandates that the single base premium be computed on the **higher of** the two coverages. The fix passes `loan_amount_cents` from the orchestrator into the NC state calculator, which applies `max(owner_liability, loan_amount)` as the base-premium input while preserving the original owner coverage in the `liability_cents` output field. Two files change; no other state is affected.

## Technical Context

**Language/Version**: Ruby 3.4.8
**Primary Dependencies**: thor ~> 1.3, sqlite3 ~> 1.6, csv (stdlib)
**Storage**: SQLite with Sequel ORM — rate tiers queried via `Models::RateTier.calculate_rate`
**Testing**: RSpec ~> 3.12; CSV-driven scenario tests in `spec/fixtures/scenarios_input.csv`
**Target Platform**: Linux (CLI tool)
**Project Type**: Single project
**Performance Goals**: N/A — batch-style CLI calculator
**Constraints**: All monetary values in cents (integers). NC rounds liability UP to nearest $1,000 before tier lookup.
**Scale/Scope**: Two-file change. NC calculator + orchestrator. Zero changes to other states.

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| **I — State Isolation** | PASS | Only `States::NC` implements the PR-4 logic. The orchestrator passes `loan_amount_cents` in the params hash to all states, but only NC reads it — other calculators ignore unknown keys. No cross-state dependency is introduced. |
| **II — Contract-First Design** | PASS | `BaseStateCalculator` defines the interface via `calculate_owners_premium(params)`. The params hash is the established extension point; adding a key does not change the contract signature. |
| **III — Prove Before Extracting** | PASS | No extraction. The max-of-two-coverages rule is NC-specific (PR-4). Even if another state later has a similar rule, it will be implemented independently per Principle I. |
| **IV — Configuration Over Scattered Conditionals** | PASS | No new conditional added to the orchestrator. The loan amount is passed as data; the NC calculator reads it. State-specific behaviour lives in the state calculator, not in `calculator.rb`. |
| **V — CSV Scenario Coverage** | FLAGGED — HUMAN ACTION REQUIRED | A new scenario (Owner $300k, Loan $350k) is needed to cover the loan-exceeds-owner path. Per Principle V, the agent MUST NOT add rows to `scenarios_input.csv`. The expected values are provided in the spec's acceptance scenario and verified manually against PR-2 tiers (see research.md). The user must add the CSV row. |
| **VI — Documentation Accessibility** | PASS | `research.md` documents the rate-manual rule, the manual tier verification, and the design rationale in plain language. |

## Project Structure

### Documentation (this feature)

```text
specs/005-fix-nc-simul-premium/
├── plan.md              # This file
├── research.md          # Phase 0 output — rule analysis, math verification, design rationale
├── data-model.md        # Phase 1 output — data flow and field mapping
├── quickstart.md        # Phase 1 output — how to run and verify
├── contracts/
│   └── nc_owners_premium.md   # Phase 1 output — NC calculator input/output contract
└── tasks.md             # Phase 2 output (generated by /speckit.tasks — NOT created here)
```

### Source Code (repository root)

```text
lib/ratenode/
├── calculator.rb                      # Orchestrator — passes loan_amount_cents to state calcs
└── calculators/
    └── states/
        └── nc.rb                      # NC calculator — reads loan_amount_cents, applies PR-4 max

spec/
└── fixtures/
    └── scenarios_input.csv            # HUMAN ACTION: add loan-exceeds-owner scenario row
```

**Structure Decision**: Single-project layout. Only two source files are modified. No new files are created in `lib/`. The change is surgical: one new key in the params hash at the orchestrator, one conditional in the NC calculator's private `calculate_standard` method.

## Complexity Tracking

> No Constitution Check violations requiring justification. The Principle V flag is a required human action item, not a violation.
